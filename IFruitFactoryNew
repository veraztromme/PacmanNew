public interface IFruitFactory
{
    Board board { get; }

    Random random { get; }

    void Update(Game game);

    void FruitEaten();
}

public abstract class AbstractFruitFactory : IFruitFactory
{
    public Board board { get; private set; }
    public Random random { get; private set; } = new Random();

    
    protected List<(string name, char symbol, int points, ConsoleColor color)> fruits = new()
{
    ("cherry", 'o', 100, ConsoleColor.Magenta),
    ("strawberry", 'o', 300, ConsoleColor.DarkRed),
    ("orange", 'o', 500, ConsoleColor.Yellow),
    ("apple", 'o', 700, ConsoleColor.Cyan),
    ("melon", 'o', 1000, ConsoleColor.Green)
};

    protected int nextFruitIndex = 0;
    protected int frameDelay = 0;

    public AbstractFruitFactory(Board board)
    {
        this.board = board;
    }

    
    public abstract void Update(Game game);

    
    public void FruitEaten()
    {
        nextFruitIndex++;
        frameDelay = 20;
    }

    protected bool IsFruitOnBoard()
    {
        
        IEnumerator<((int row, int col), IBoardObject)> enumerator = board.GetEnumerator();
        while (enumerator.MoveNext())
        {
            var (_, obj) = enumerator.Current;
            if (obj is Fruit)
                return true;
        }
        return false;
    }

   
    protected bool IsLivesOnBoard()
    {
        IEnumerator<((int row, int col), IBoardObject)> enumerator = board.GetEnumerator();
        while (enumerator.MoveNext())
        {
            var (_, obj) = enumerator.Current;
            if (obj is Lives)
                return true;
        }
        return false;
    }

    protected (int row, int col)? GetRandomEmptySpot()
    {
        
        List<(int row, int col)> emptySpots = new();
        IEnumerator<((int row, int col), IBoardObject)> enumerator = board.GetEnumerator();

        while (enumerator.MoveNext())
        {
            var (coords, obj) = enumerator.Current;
            if (obj is Empty)
                emptySpots.Add(coords);
        }

        if (emptySpots.Count == 0)
            return null;

        return emptySpots[random.Next(emptySpots.Count)];
    }

    protected void SpawnFruit(Game game, (int row, int col) pos)
    {
        if (nextFruitIndex < fruits.Count)
        {
            var fruit = fruits[nextFruitIndex];
            board.grid[pos.row][pos.col] = new Fruit(
                fruit.symbol, fruit.points, fruit.name, fruit.color, this, game
            );
        }
    }
}

 public class FruitFactoryEasy : AbstractFruitFactory
 {
     
     private const double LivesChance = 0.20;

     
     public FruitFactoryEasy(Board board) : base(board) { }

     
     public override void Update(Game game)
     {
         
         if (IsFruitOnBoard() || IsLivesOnBoard())
             return;

         if (frameDelay > 0)
         {
             frameDelay--;
             return;
         }

         var pos = GetRandomEmptySpot();
         if (!pos.HasValue)
             return;

         
         if (random.NextDouble() < LivesChance)
         {
             board.grid[pos.Value.row][pos.Value.col] = new Lives();
         }
         else
         {
             SpawnFruit(game, pos.Value);
         }
     }
 }

 public class FruitFactoryHard : AbstractFruitFactory
 {
     
     public FruitFactoryHard(Board board) : base(board) { }

   
     public override void Update(Game game)
     {
        
         if (IsFruitOnBoard())
             return;

         if (frameDelay > 0)
         {
             frameDelay--;
             return;
         }

     
         var pos = GetRandomEmptySpot();
         if (pos.HasValue)
         {
             
             SpawnFruit(game, pos.Value);
         }
     }
 }
